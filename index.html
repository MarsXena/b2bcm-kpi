<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pharma KPI Recommender • B2BCM</title>
  <meta name="description" content="B2BCM Pharma KPI Recommender — connect business goals with measurable, compliance-aware KPIs." />
  <style>
    :root{
      --bg1:#0b1020; --bg2:#0c1124; --bg3:#0b0f1f;
      --text:#e6ebff; --muted:#b9c0d0;
      --border: rgba(255,255,255,.08); --border2: rgba(255,255,255,.12);
      --panel: rgba(255,255,255,.03); --panel2: rgba(255,255,255,.06);
      --amber:#f5b301; --accent:#7c6cf3;
      --green:#22c55e; --yellow:#eab308; --red:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 50% -10%, #1d2240 0%, transparent 60%),
                  radial-gradient(800px 400px at 10% 30%, #241a46 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg2), var(--bg1) 60%, var(--bg3));
    }
    .wrap{max-width:1020px; margin:0 auto; padding:56px 20px 80px}
    header h1{margin:0 0 8px; text-align:center; font-size:44px; letter-spacing:.3px}
    header p{margin:0; text-align:center; color:var(--muted)}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:16px}
    .panel-header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:16px; border-bottom:1px solid var(--border)}
    .panel-title{margin:0; font-size:16px; font-weight:600}
    .panel-sub{margin:2px 0 0; color:var(--muted); font-size:12px}
    .controls{margin:28px auto 0; max-width:840px}
    .group{display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding:12px 16px}
    .group label{min-width:140px; color:var(--muted); font-size:13px}
    .chip-btn{border:1px solid var(--border2); background:rgba(255,255,255,.04); color:var(--text); padding:8px 12px; border-radius:999px; font-size:14px; cursor:pointer}
    .chip-btn[aria-pressed="true"]{outline:2px solid #3b82f6; outline-offset:1px; background:rgba(59,130,246,.15)}
    .btn{appearance:none; border:1px solid var(--border2); background:rgba(255,255,255,.06); color:var(--text); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer}
    .btn-amber{background:rgba(245,179,1,.12); border-color:rgba(245,179,1,.35)}
    .btn:hover{filter:brightness(1.1)}
    .bar-actions{display:flex; gap:10px; justify-content:center; padding:12px 16px}
    .muted{color:var(--muted)}
    .hidden{display:none}

    /* selects */
    .select{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e6ebff;padding:10px 12px;border-radius:12px}

    /* Results table */
    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; font-size:14px}
    th{color:#cfd6ea; font-weight:600}
    .chip{display:inline-block; padding:.15rem .55rem; border-radius:999px; border:1px solid var(--border2); font-size:11px; letter-spacing:.02em}
    .dot{display:inline-block; width:10px; height:10px; border-radius:999px; vertical-align:-1px}
    .dot-green{background:var(--green)} .dot-yellow{background:var(--yellow)} .dot-red{background:var(--red)}
    .status-text{font-size:11px; letter-spacing:.04em; opacity:.9; margin-left:6px}
    .actual-cell{min-width:72px; border-radius:8px}
    .actual-cell:focus{outline:2px solid #3b82f6; background:rgba(59,130,246,.12)}

    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:16px 0}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px}
    .card.stat .label{color:var(--muted); font-size:12px}
    .card.stat .value{display:flex; align-items:center; gap:8px; font-size:26px; font-weight:700}

    .footer{margin-top:28px; text-align:center; color:var(--muted); font-size:12px}
    a.link{color:#c5b8ff; text-decoration:none} a.link:hover{text-decoration:underline}

    /* Segmented toggle */
    .seg{display:inline-flex; border:1px solid var(--border2); border-radius:12px; overflow:hidden}
    .seg button{padding:8px 12px; background:transparent; color:var(--text); border:0; cursor:pointer}
    .seg button[aria-pressed="true"]{background:rgba(255,255,255,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Pharma KPI Recommender</h1>
      <p>Pick your scenario → get recommended KPIs, data sources, and next actions.</p>
    </header>

    <!-- UI style switch -->
    <div class="bar-actions" aria-label="UI style switch">
      <span class="muted" style="align-self:center">UI Style</span>
      <div class="seg" role="tablist" aria-label="UI Style">
        <button id="styleChips" role="tab" aria-selected="true" aria-pressed="true">Chips</button>
        <button id="styleDropdowns" role="tab" aria-selected="false" aria-pressed="false">Dropdowns</button>
      </div>
    </div>

    <!-- Scenario Controls (CHIPS) -->
    <section id="controlsChips" class="panel controls" aria-label="Scenario controls (chips)">
      <div class="group">
        <label>Goal</label>
        <button class="chip-btn" data-chip="goal" aria-pressed="true">Awareness</button>
        <button class="chip-btn" data-chip="goal">Engagement</button>
        <button class="chip-btn" data-chip="goal">Conversion</button>
      </div>
      <div class="group">
        <label>Audience</label>
        <button class="chip-btn" data-chip="aud" aria-pressed="true">HCP</button>
        <button class="chip-btn" data-chip="aud">Patient</button>
      </div>
      <div class="group">
        <label>Channel</label>
        <button class="chip-btn" data-chip="chn" aria-pressed="true">Paid</button>
        <button class="chip-btn" data-chip="chn">Email</button>
        <button class="chip-btn" data-chip="chn">Field</button>
      </div>
      <div class="group">
        <label>Constraint</label>
        <button class="chip-btn" data-chip="con" aria-pressed="true">Compliance-first</button>
        <button class="chip-btn" data-chip="con">Budget</button>
        <button class="chip-btn" data-chip="con">Speed</button>
      </div>
      <div class="group">
        <label>Lifecycle Stage</label>
        <button class="chip-btn" data-chip="life" aria-pressed="true">Launch</button>
        <button class="chip-btn" data-chip="life">Growth</button>
        <button class="chip-btn" data-chip="life">LOE</button>
      </div>
      <div class="group">
        <label>Therapeutic Area</label>
        <button class="chip-btn" data-chip="ta" aria-pressed="true">Oncology</button>
        <button class="chip-btn" data-chip="ta">Cardio</button>
        <button class="chip-btn" data-chip="ta">Immunology</button>
      </div>
      <div class="bar-actions">
        <a class="btn btn-amber" href="./B2BCM_Pharma_KPI_Map.xlsx" download>⬇ Download Excel KPI Map</a>
        <a class="btn" href="mailto:j.gracey@b2bcreativemarketing.com?subject=B2BCM%20Pharma%20KPI%20Rollout">Talk about a personalized rollout</a>
      </div>
      <div class="bar-actions">
        <button id="recommendBtn" class="btn btn-amber">Recommend KPIs</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </section>

    <!-- Scenario Controls (DROPDOWNS) -->
    <section id="controlsDropdowns" class="panel controls hidden" aria-label="Scenario controls (dropdowns)">
      <div class="group"><label>Goal</label>
        <select id="selGoal" class="select"><option>Awareness</option><option>Engagement</option><option>Conversion</option></select>
      </div>
      <div class="group"><label>Audience</label>
        <select id="selAudience" class="select"><option>HCP</option><option>Patient</option></select>
      </div>
      <div class="group"><label>Channel</label>
        <select id="selChannel" class="select"><option>Paid</option><option>Email</option><option>Field</option></select>
      </div>
      <div class="group"><label>Constraint</label>
        <select id="selConstraint" class="select"><option>Compliance-first</option><option>Budget</option><option>Speed</option></select>
      </div>
      <div class="group"><label>Lifecycle Stage</label>
        <select id="selLifecycle" class="select"><option>Launch</option><option>Growth</option><option>LOE</option></select>
      </div>
      <div class="group"><label>Therapeutic Area</label>
        <select id="selTA" class="select"><option>Oncology</option><option>Cardio</option><option>Immunology</option></select>
      </div>
      <div class="bar-actions">
        <a class="btn btn-amber" href="./B2BCM_Pharma_KPI_Map.xlsx" download>⬇ Download Excel KPI Map</a>
        <a class="btn" href="mailto:j.gracey@b2bcreativemarketing.com?subject=B2BCM%20Pharma%20KPI%20Rollout">Talk about a personalized rollout</a>
      </div>
      <div class="bar-actions">
        <button id="recommendBtn2" class="btn btn-amber">Recommend KPIs</button>
        <button id="resetBtn2" class="btn">Reset</button>
      </div>
    </section>

    <!-- Results: Pharma KPI Pack -->
    <section id="kpi-results" class="panel" style="display:none; margin-top:28px;">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Recommended KPIs (Pharma Pack)</h2>
          <p class="panel-sub">Category-colored with simple benchmark status</p>
        </div>
        <div class="panel-actions">
          <button id="exportCsvBtn" class="btn">Export CSV</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="kpi-table" id="kpiTable">
          <thead>
            <tr>
              <th>KPI</th><th>Category</th><th>Target</th><th>Actual</th>
              <th>Metric</th><th>Frequency</th><th>Status</th><th>Notes</th>
            </tr>
          </thead>
          <tbody><!-- injected by JS --></tbody>
        </table>
      </div>
    </section>

    <section id="kpi-stats" style="display:none;">
      <div class="grid-3">
        <div class="card stat"><div class="label">Good</div><div class="value"><span class="dot dot-green"></span><span id="goodCount">0</span></div></div>
        <div class="card stat"><div class="label">Watch</div><div class="value"><span class="dot dot-yellow"></span><span id="watchCount">0</span></div></div>
        <div class="card stat"><div class="label">Action</div><div class="value"><span class="dot dot-red"></span><span id="actionCount">0</span></div></div>
      </div>
      <div class="card"><h3 style="margin:0 0 8px; font-size:16px;">Insight Summary</h3><p id="insightSummary" class="muted" style="margin:0;"></p></div>
    </section>

    <p class="footer">© <span id="yr"></span> B2B Creative Marketing • Technology partnerships powered by Integrated Eight™</p>
  </div>

  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();

    // UI style toggle
    const chipsBtn = document.getElementById('styleChips');
    const ddBtn = document.getElementById('styleDropdowns');
    const chipsSection = document.getElementById('controlsChips');
    const ddSection = document.getElementById('controlsDropdowns');
    function setStyle(mode){
      const chips = mode === 'chips';
      chipsSection.classList.toggle('hidden', !chips);
      ddSection.classList.toggle('hidden', chips);
      chipsBtn.setAttribute('aria-pressed', chips);
      ddBtn.setAttribute('aria-pressed', !chips);
      chipsBtn.setAttribute('aria-selected', chips);
      ddBtn.setAttribute('aria-selected', !chips);
      localStorage.setItem('b2bcm_ui_style', mode);
    }
    chipsBtn.addEventListener('click',()=>setStyle('chips'));
    ddBtn.addEventListener('click',()=>setStyle('dropdowns'));
    setStyle(localStorage.getItem('b2bcm_ui_style')||'chips');

    // Simple chip selection behavior
    document.querySelectorAll('.chip-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const groupAttr = btn.getAttribute('data-chip');
        document.querySelectorAll('.chip-btn[data-chip="'+groupAttr+'"]').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
      });
    });

    // Category chip styles (dark palette)
    const CATEGORY_STYLES = {
      "HCP Engagement": { bg:"#0b3e8515", text:"#8bb4ff", border:"#335ea6" },
      "Field Force":    { bg:"#0a5a4315", text:"#76e1b8", border:"#2aa67f" },
      "Patient Journey":{ bg:"#7a4a0115", text:"#ffc76e", border:"#b97a1d" },
      "Compliance":     { bg:"#7a2f0015", text:"#ffb38a", border:"#b25522" },
      "Brand Health":   { bg:"#3f196f15", text:"#c6a9ff", border:"#7b56cc" },
    };

    // Seed KPIs
    const STORAGE_KEY = 'b2bcm_pharma_kpis_v2';
    const DEFAULT_KPIS = [
      { id:"k1", name:"HCP Reach Rate",        category:"HCP Engagement", metricType:"%",    target:75, actual:68, frequency:"Monthly",   notes:"IQVIA + Veeva CRM" },
      { id:"k2", name:"Email Open Rate",       category:"HCP Engagement", metricType:"%",    target:28, actual:31, frequency:"Weekly",    notes:"SFMC (Approved Email)" },
      { id:"k3", name:"Content Recall Score",  category:"Brand Health",   metricType:"%",    target:60, actual:55, frequency:"Quarterly", notes:"Medscape / Panel" },
      { id:"k4", name:"Review Cycle Time",     category:"Compliance",     metricType:"days", target:10, actual:12, frequency:"Monthly",   notes:"Veeva PromoMats" },
      { id:"k5", name:"Adherence (6 mo)",      category:"Patient Journey",metricType:"%",    target:70, actual:74, frequency:"Bi-Annual", notes:"Specialty Pharmacy Feed" },
      { id:"k6", name:"Digital Detailing Rate",category:"Field Force",    metricType:"%",    target:25, actual:19, frequency:"Monthly",   notes:"Veeva CLM / OCE" },
    ];

    let PHARMA_KPIS = restoreKpis();

    function restoreKpis(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return JSON.parse(JSON.stringify(DEFAULT_KPIS));
      try{
        const saved = JSON.parse(raw);
        // merge with defaults in case of version changes
        const merged = DEFAULT_KPIS.map((d,i)=> ({...d, ...(saved[i]||{})}));
        return merged;
      }catch{ return JSON.parse(JSON.stringify(DEFAULT_KPIS)); }
    }

    // Status logic
    function statusFor(kpi){
      const lowerIsBetter = String(kpi.metricType).toLowerCase().includes('day');
      const ratio = (kpi.actual / kpi.target) * 100;
      if (lowerIsBetter){
        if (ratio <= 105) return 'green';
        if (ratio <= 120) return 'yellow';
        return 'red';
      } else {
        if (ratio >= 95) return 'green';
        if (ratio >= 80) return 'yellow';
        return 'red';
      }
    }

    function chip(category){
      const s = CATEGORY_STYLES[category] || {};
      return `<span class="chip" style="background:${s.bg||'transparent'}; color:${s.text||'#ddd'}; border:1px solid ${s.border||'#555'};">${category}</span>`;
    }
    function dot(color){
      const map = { green:'#22c55e', yellow:'#eab308', red:'#ef4444' };
      return `<span class="dot" style="background:${map[color]||'#999'};"></span>`;
    }

    function renderKpiResults(kpis){
      const tbody = document.querySelector('#kpiTable tbody');
      const rows = kpis.map((k,i)=>{
        const s = statusFor(k);
        const actualDisplay = k.actual + (k.metricType === '%' ? '%' : '');
        const targetDisplay = k.target + (k.metricType === '%' ? '%' : '');
        return `
          <tr data-index="${i}">
            <td>${k.name}</td>
            <td>${chip(k.category)}</td>
            <td>${targetDisplay}</td>
            <td contenteditable="true" class="actual-cell">${actualDisplay}</td>
            <td>${k.metricType}</td>
            <td>${k.frequency}</td>
            <td class="status-cell">${dot(s)} <span class="status-text">${s.toUpperCase()}</span></td>
            <td class="muted">${k.notes}</td>
          </tr>`;
      }).join('');
      tbody.innerHTML = rows;

      // attach inline edit listeners
      document.querySelectorAll('.actual-cell').forEach(cell=>{
        cell.addEventListener('blur', onActualEdit);
        cell.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); cell.blur(); } });
      });

      updateTalliesAndSummary(kpis);
      showResults();
    }

    function onActualEdit(e){
      const row = e.target.closest('tr');
      const idx = Number(row.dataset.index);
      const k = PHARMA_KPIS[idx];
      const text = e.target.textContent.trim().replace('%','');
      const val = Number(text);
      if(!Number.isFinite(val)){
        // revert to previous
        e.target.textContent = k.actual + (k.metricType==='%'?'%':'');
        return;
      }
      k.actual = val;
      persistKpis();
      // update status
      const s = statusFor(k);
      row.querySelector('.status-cell').innerHTML = `${dot(s)} <span class="status-text">${s.toUpperCase()}</span>`;
      updateTalliesAndSummary(PHARMA_KPIS);
    }

    function updateTalliesAndSummary(kpis){
      const t = { green:0, yellow:0, red:0 };
      kpis.forEach(k=> t[statusFor(k)]++ );
      document.getElementById('goodCount').textContent = t.green;
      document.getElementById('watchCount').textContent = t.yellow;
      document.getElementById('actionCount').textContent = t.red;
      const score = t.green*2 + t.yellow*1 - t.red*1;
      const overall = score >= 4 ? 'green' : score >= 1 ? 'yellow' : 'red';
      document.getElementById('insightSummary').textContent =
        overall==='green' ? 'Strong overall performance: maintain cadence and reinforce high-performing channels.' :
        overall==='yellow' ? 'Mixed signals: tighten execution on underperformers and review message–channel fit.' :
        'Priority action required: investigate low KPIs and address bottlenecks this cycle.';
    }

    function showResults(){
      document.getElementById('kpi-results').style.display = 'block';
      document.getElementById('kpi-stats').style.display = 'block';
      window.scrollTo({ top: document.getElementById('kpi-results').offsetTop - 20, behavior:'smooth' });
    }

    function persistKpis(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(PHARMA_KPIS)); }

    function exportCsv(kpis){
      const headers = ["KPI","Category","Target","Actual","Metric","Frequency","Status","Notes"];
      const rows = kpis.map(k=> [k.name,k.category,k.target,k.actual,k.metricType,k.frequency,statusFor(k),k.notes]);
      const csv = [headers, ...rows].map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "b2bcm_kpi_pharma_demo.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    // Buttons
    document.getElementById('recommendBtn').addEventListener('click', ()=>{ PHARMA_KPIS = restoreKpis(); renderKpiResults(PHARMA_KPIS); });
    document.getElementById('recommendBtn2').addEventListener('click', ()=>{ PHARMA_KPIS = restoreKpis(); renderKpiResults(PHARMA_KPIS); });
    document.getElementById('exportCsvBtn').addEventListener('click', ()=> exportCsv(PHARMA_KPIS));

    function resetView(){
      document.getElementById('kpi-results').style.display = 'none';
      document.getElementById('kpi-stats').style.display = 'none';
      document.querySelector('#kpiTable tbody').innerHTML = '';
      document.getElementById('insightSummary').textContent='';
      document.getElementById('goodCount').textContent='0';
      document.getElementById('watchCount').textContent='0';
      document.getElementById('actionCount').textContent='0';
    }
    document.getElementById('resetBtn').addEventListener('click', ()=>{ resetView(); /* keep persisted values */ });
    document.getElementById('resetBtn2').addEventListener('click', ()=>{ resetView(); });

  </script>
</body>
</html>
